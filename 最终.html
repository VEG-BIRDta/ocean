e

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’åŠ¨å¼ç”µå­æµ·æ´‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .painting-area, .gallery-area {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .gallery-area {
            flex: 0.7;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px;
        }
        
        .toolbar {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .tool-group label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        select, input, button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 0.9rem;
        }
        
        button {
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        button.clear {
            background: #f44336;
        }
        
        button.clear:hover {
            background: #d32f2f;
        }
        
        .canvas-wrapper {
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
            height: 500px;
        }
        
        #main-canvas {
            display: block;
            background: #1a2980;
            cursor: crosshair;
            width: 100%;
            height: 100%;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
            flex: 1;
            /* åˆ é™¤å›ºå®šé«˜åº¦ï¼Œè®©ç”»å»Šå æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
        }
        
        .fish-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .fish-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .fish-preview {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }
        
        .fish-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .fish-desc {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ç”»å»Šåœºæ™¯æ ·å¼ */
        .gallery-scene {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            z-index: 2000;
            padding: 20px;
        }
        
        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .gallery-background-selector {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .gallery-background-selector select {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: #333;
            cursor: pointer;
        }
        
        .back-btn {
            background: #ff6b6b;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .back-btn:hover {
            background: #ff5252;
        }
        
        .ocean-scene {
            position: relative;
            height: calc(100vh - 100px);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .fish-in-ocean {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .fish-in-ocean:hover {
            transform: scale(1.2);
        }
        
        .fish-popup {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: none;
        }
        
        /* æ•…äº‹æ ‡ç­¾æ ·å¼ */
        .story-tag {
            position: absolute;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            border-radius: 15px;
            cursor: move;
            z-index: 15;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-delete {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .story-tag:hover .tag-delete {
            opacity: 1;
            visibility: visible;
        }
        
        /* æµ·åº•å…ƒç´ æ ·å¼ */
        .sea-element {
            position: absolute;
            font-size: 2rem;
            cursor: move;
            z-index: 12;
        }
        
        .element-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .sea-element:hover .element-delete {
            opacity: 1;
            visibility: visible;
        }
        
        /* é±¼è½®å»“å‚è€ƒæ ·å¼ */
        .fish-outline {
            position: absolute;
            pointer-events: none;
            z-index: 5;
            opacity: 0.3;
            border: 2px dashed #fff;
        }
        
        /* èƒŒæ™¯é€‰æ‹©æ ·å¼ */
        .background-option {
            padding: 5px 10px;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .background-option.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .gallery-area {
                flex: 1;
            }
        }
        
        .color-picker {
            display: flex;
            gap: 5px;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .color-option.active {
            border-color: white;
            transform: scale(1.2);
        }
        
        .brush-size {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .brush-size input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒŠ äº’åŠ¨å¼ç”µå­æµ·æ´‹</h1>
            <p class="subtitle">ç»˜åˆ¶æ‚¨çš„æµ·æ´‹ç”Ÿç‰©ï¼Œä¸å…¶ä»–åˆ›ä½œè€…çš„é±¼å„¿å…±åŒæ¸¸åŠ¨åœ¨ç”µå­æµ·æ´‹ä¸­ï¼</p>
        </header>
        
        <div class="main-content">
            <div class="painting-area">
                <h2 class="section-title">ğŸ¨ ç»˜ç”»åŒº</h2>
                
                <div class="toolbar">
                    <div class="tool-group">
                        <label>ç”»ç¬”é¢œè‰²</label>
                        <div class="color-picker">
                            <div class="color-option active" style="background-color: #000000;" data-color="#000000"></div>
                            <div class="color-option" style="background-color: #ff4757;" data-color="#ff4757"></div>
                            <div class="color-option" style="background-color: #2ed573;" data-color="#2ed573"></div>
                            <div class="color-option" style="background-color: #1e90ff;" data-color="#1e90ff"></div>
                            <div class="color-option" style="background-color: #ffa502;" data-color="#ffa502"></div>
                            <div class="color-option" style="background-color: #ffffff;" data-color="#ffffff"></div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <label>ç”»ç¬”å¤§å°</label>
                        <div class="brush-size">
                            <input type="range" id="brush-size" min="1" max="20" value="3">
                            <span id="brush-size-value">3px</span>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <label>é±¼è½®å»“å‚è€ƒ</label>
                        <select id="fish-outline">
                            <option value="none">æ— å‚è€ƒ</option>
                            <option value="fish1">å°é±¼è½®å»“</option>
                            <option value="fish2">é²¨é±¼è½®å»“</option>
                            <option value="fish3">æ°´æ¯è½®å»“</option>
                            <option value="fish4">æµ·é¾Ÿè½®å»“</option>
                        </select>
                    </div>
                    
                    <div class="tool-group">
                        <label>æ•…äº‹æ ‡ç­¾</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="tag-text" placeholder="è¾“å…¥æ ‡ç­¾å†…å®¹ï¼ˆé™20å­—ï¼‰">
                            <button id="add-tag">æ·»åŠ </button>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <label>æµ·åº•å…ƒç´ </label>
                        <select id="sea-element">
                            <option value="none">é€‰æ‹©å…ƒç´ </option>
                            <option value="coral">çŠç‘š</option>
                            <option value="seaweed">æ°´è‰</option>
                            <option value="rock">å²©çŸ³</option>
                            <option value="bubble">æ°”æ³¡</option>
                        </select>
                    </div>
                </div>
                
                <div class="canvas-wrapper">
                    <canvas id="main-canvas"></canvas>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                    <button id="submit-fish">æäº¤æˆ‘çš„é±¼</button>
                    <button id="clear-canvas" class="clear">æ¸…ç©ºç”»å¸ƒ</button>
                    <button id="enter-gallery" style="background: linear-gradient(45deg, #00d2ff, #0072ff); border: none; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0, 114, 255, 0.3); transition: all 0.3s ease;">ğŸ  è¿›å…¥æµ·æ´‹ç”Ÿç‰©ç”»å»Š</button>
                </div>
            </div>
            
            <div class="gallery-area">
                <h2 class="section-title" id="gallery-title">ğŸ  æµ·æ´‹ç”Ÿç‰©ç”»å»Š</h2>
                <div class="gallery" id="fish-gallery">
                    <!-- ç¤ºä¾‹é±¼ -->
                    <div class="fish-card">
                        <div class="fish-preview">ğŸŸ</div>
                        <div class="fish-name">å°ä¸‘é±¼å°¼è«</div>
                        <div class="fish-desc">æ©™è‰²æ¡çº¹ï¼Œæ´»æ³¼å¥½åŠ¨</div>
                    </div>
                    <div class="fish-card">
                        <div class="fish-preview">ğŸ¦ˆ</div>
                        <div class="fish-name">å¤§ç™½é²¨</div>
                        <div class="fish-desc">æµ·æ´‹éœ¸ä¸»ï¼Œå¨é£å‡›å‡›</div>
                    </div>
                    <div class="fish-card">
                        <div class="fish-preview">ğŸ¢</div>
                        <div class="fish-name">æµ·é¾Ÿæ…¢æ…¢</div>
                        <div class="fish-desc">é•¿å¯¿æ™ºè€…ï¼Œæ‚ ç„¶è‡ªå¾—</div>
                    </div>
                    <div class="fish-card">
                        <div class="fish-preview">ğŸ™</div>
                        <div class="fish-name">ç« é±¼åšå£«</div>
                        <div class="fish-desc">å…«çˆªçµæ´»ï¼Œèªæ˜æœºæ™º</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç”»å»Šåœºæ™¯ -->
    <div class="gallery-scene" id="gallery-scene">
        <div class="gallery-header">
            <button class="back-btn" id="back-to-painting">â† è¿”å›ç»˜ç”»</button>
            <h2>ğŸ  ç”µå­æµ·æ´‹åœºæ™¯</h2>
            <div class="gallery-background-selector">
                <select id="gallery-background-theme">
                    <option value="spongebob">æµ·ç»µå®å®åœºæ™¯</option>
                    <option value="octonauts">æµ·åº•å°çºµé˜Ÿåœºæ™¯</option>
                    <option value="nemo">æµ·åº•æ€»åŠ¨å‘˜åœºæ™¯</option>
                </select>
            </div>
        </div>
        <div class="ocean-scene" id="ocean-scene">
            <div class="fish-popup" id="fish-popup"></div>
        </div>
    </div>
    
    <!-- æäº¤é±¼çš„æ¨¡æ€æ¡† -->
    <div id="fish-modal" class="modal">
        <div class="modal-content">
            <h3>æäº¤æ‚¨çš„æµ·æ´‹ç”Ÿç‰©</h3>
            <input type="text" id="fish-name" class="modal-input" placeholder="è¾“å…¥ç”Ÿç‰©åç§°ï¼ˆå¦‚ï¼šå°ä¸‘é±¼å°¼è«ï¼‰">
            <input type="text" id="fish-description" class="modal-input" placeholder="è¾“å…¥ç”Ÿç‰©æè¿°ï¼ˆé™20å­—ï¼‰">
            <div class="modal-buttons">
                <button id="cancel-submit" class="clear">å–æ¶ˆ</button>
                <button id="confirm-submit">ç¡®è®¤æäº¤</button>
            </div>
        </div>
    </div>
    
    <script>
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†æ‰§è¡Œäº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆè·å–æ‰€æœ‰éœ€è¦çš„DOMå…ƒç´ 
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            const brushSizeInput = document.getElementById('brush-size');
            const brushSizeValue = document.getElementById('brush-size-value');
            const submitFishBtn = document.getElementById('submit-fish');
            const fishModal = document.getElementById('fish-modal');
            const cancelSubmitBtn = document.getElementById('cancel-submit');
            const confirmSubmitBtn = document.getElementById('confirm-submit');
            const enterGalleryBtn = document.getElementById('enter-gallery');
            const backToPaintingBtn = document.getElementById('back-to-painting');
            const galleryTitle = document.getElementById('gallery-title');
            const galleryScene = document.getElementById('gallery-scene');
            const oceanScene = document.getElementById('ocean-scene');
            const fishPopup = document.getElementById('fish-popup');
            const galleryBackgroundTheme = document.getElementById('gallery-background-theme');
            const fishOutlineSelect = document.getElementById('fish-outline');
            const addTagBtn = document.getElementById('add-tag');
            const tagTextInput = document.getElementById('tag-text');
            const seaElementSelect = document.getElementById('sea-element');
            const clearCanvasBtn = document.getElementById('clear-canvas');
            const fishGallery = document.getElementById('fish-gallery');
            
            // å…¨å±€å˜é‡
            let currentOutline = null;
            let storyTags = [];
            let seaElements = [];
            let userFish = [];
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let currentColor = '#000000';
            let brushSize = 3;
            let currentGalleryBackground = 'spongebob';
            let galleryBackgroundImages = {};
            
            // æµ·æ´‹ç”»å»ŠèƒŒæ™¯æ•°æ®ï¼ˆä½¿ç”¨ç”¨æˆ·æä¾›çš„æœ¬åœ°å›¾ç‰‡ï¼‰
            const galleryBackgrounds = {
                spongebob: {
                    image: 'imgs/gallery_backgrounds/spongebob_bg.png',
                    name: 'æµ·ç»µå®å®åœºæ™¯'
                },
                octonauts: {
                    image: 'imgs/gallery_backgrounds/octonauts_bg.jpg',
                    name: 'æµ·åº•å°çºµé˜Ÿåœºæ™¯'
                },
                nemo: {
                    image: 'imgs/gallery_backgrounds/finding_nemo_bg.jpg',
                    name: 'æµ·åº•æ€»åŠ¨å‘˜åœºæ™¯'
                }
            };
            
            // è®¾ç½®Canvaså°ºå¯¸
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                
                // é‡æ–°ç»˜åˆ¶èƒŒæ™¯
                drawBackground();
                
                // é‡æ–°ç»˜åˆ¶é±¼è½®å»“å‚è€ƒ
                if (currentOutline) {
                    drawFishOutline(currentOutline);
                }
            }
            
            // ç»˜åˆ¶æµ·æ´‹èƒŒæ™¯ï¼ˆåˆ é™¤èƒŒæ™¯ä¸»é¢˜åˆ‡æ¢ï¼Œä¿æŒé»˜è®¤æµ·æ´‹èƒŒæ™¯ï¼‰
            function drawBackground() {
                // ä½¿ç”¨å›ºå®šçš„æµ·æ´‹æ¸å˜èƒŒæ™¯
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#1a2980');
                gradient.addColorStop(1, '#26d0ce');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶æ°”æ³¡
                for (let i = 0; i < 20; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const radius = Math.random() * 10 + 5;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.stroke();
                }
            }
            
            // é¢„åŠ è½½ç”»å»ŠèƒŒæ™¯å›¾ç‰‡
            function preloadGalleryImage(imagePath) {
                if (galleryBackgroundImages[imagePath]) return;
                
                const img = new Image();
                img.onload = function() {
                    galleryBackgroundImages[imagePath] = img;
                    // å¦‚æœå½“å‰èƒŒæ™¯å°±æ˜¯è¿™å¼ å›¾ç‰‡ï¼Œç«‹å³æ›´æ–°èƒŒæ™¯
                    if (galleryBackgrounds[currentGalleryBackground].image === imagePath) {
                        drawGalleryBackground();
                    }
                };
                img.onerror = function() {
                    console.log('ç”»å»ŠèƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', imagePath);
                };
                img.src = imagePath;
            }
            
            // é¢„åŠ è½½æ‰€æœ‰ç”»å»ŠèƒŒæ™¯å›¾ç‰‡
            function preloadAllGalleryBackgrounds() {
                Object.keys(galleryBackgrounds).forEach(bgKey => {
                    const bg = galleryBackgrounds[bgKey];
                    if (bg.image) {
                        preloadGalleryImage(bg.image);
                    }
                });
            }
            
            // ç»˜åˆ¶ç”»å»ŠèƒŒæ™¯
            function drawGalleryBackground() {
                const bg = galleryBackgrounds[currentGalleryBackground];
                
                // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                if (bg.image && galleryBackgroundImages[bg.image]) {
                    oceanScene.style.backgroundImage = `url(${bg.image})`;
                    oceanScene.style.backgroundSize = 'cover';
                    oceanScene.style.backgroundPosition = 'center';
                    oceanScene.style.backgroundRepeat = 'no-repeat';
                } else if (bg.image) {
                    // å¦‚æœå›¾ç‰‡è¿˜æœªåŠ è½½ï¼Œå°è¯•åŠ è½½
                    preloadGalleryImage(bg.image);
                }
            }
            
            // åˆå§‹åŒ–Canvas
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // å¯åŠ¨é¢„åŠ è½½
            preloadAllGalleryBackgrounds();
            
            // è®¾ç½®ç”»ç¬”é¢œè‰²
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    currentColor = this.getAttribute('data-color');
                });
            });
            
            // è®¾ç½®ç”»ç¬”å¤§å°
            brushSizeInput.addEventListener('input', function() {
                brushSize = this.value;
                brushSizeValue.textContent = brushSize + 'px';
            });
            
            // ç»˜ç”»åŠŸèƒ½
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.strokeStyle = currentColor;
                ctx.lineWidth = brushSize;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
            }
            
            // æ¸…ç©ºç”»å¸ƒåŠŸèƒ½ï¼ˆä¿ç•™æ•…äº‹æ ‡ç­¾ï¼‰
            clearCanvasBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿå·²æ·»åŠ çš„æ•…äº‹æ ‡ç­¾å°†ä¿ç•™ã€‚')) {
                    // æ¸…ç©ºç”»å¸ƒä½†ä¿ç•™æ ‡ç­¾
                    drawBackground();
                    removeAllSeaElements();
                }
            });
            
            // è¿›å…¥æµ·æ´‹ç”Ÿç‰©ç”»å»ŠæŒ‰é’®
            enterGalleryBtn.addEventListener('click', function() {
                showGalleryScene();
            });
            
            // æ•…äº‹æ ‡ç­¾åŠŸèƒ½
            addTagBtn.addEventListener('click', function() {
                const tagText = tagTextInput.value.trim();
                if (tagText && tagText.length <= 20) {
                    const tag = document.createElement('div');
                    tag.className = 'story-tag';
                    tag.innerHTML = `
                        <span>${tagText}</span>
                        <button class="tag-delete" title="åˆ é™¤æ ‡ç­¾">Ã—</button>
                    `;
                    
                    tag.style.left = Math.random() * (canvas.width - 120) + 'px';
                    tag.style.top = Math.random() * (canvas.height - 40) + 'px';
                    
                    canvas.parentElement.appendChild(tag);
                    
                    // ä½¿æ ‡ç­¾å¯æ‹–åŠ¨
                    makeDraggable(tag);
                    
                    // æ·»åŠ åˆ é™¤åŠŸèƒ½
                    tag.querySelector('.tag-delete').addEventListener('click', function() {
                        tag.remove();
                    });
                    
                    storyTags.push(tag);
                    tagTextInput.value = '';
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ ‡ç­¾å†…å®¹ï¼ˆé™20å­—ï¼‰');
                }
            });
            
            // æµ·åº•å…ƒç´ åŠŸèƒ½
            seaElementSelect.addEventListener('change', function() {
                const elementType = this.value;
                if (elementType !== 'none') {
                    addSeaElement(elementType);
                }
            });
            
            function addSeaElement(type) {
                const element = document.createElement('div');
                element.className = 'sea-element';
                
                let emoji, title;
                switch(type) {
                    case 'coral':
                        emoji = 'ğŸª¸';
                        title = 'çŠç‘š';
                        break;
                    case 'seaweed':
                        emoji = 'ğŸŒ¿';
                        title = 'æ°´è‰';
                        break;
                    case 'rock':
                        emoji = 'ğŸª¨';
                        title = 'å²©çŸ³';
                        break;
                    case 'bubble':
                        emoji = 'ğŸ’§';
                        title = 'æ°”æ³¡';
                        break;
                }
                
                element.innerHTML = `
                    ${emoji}
                    <button class="element-delete" title="åˆ é™¤å…ƒç´ ">Ã—</button>
                `;
                
                element.style.left = Math.random() * (canvas.width - 60) + 'px';
                element.style.top = Math.random() * (canvas.height - 60) + 'px';
                
                canvas.parentElement.appendChild(element);
                
                // ä½¿å…ƒç´ å¯æ‹–åŠ¨
                makeDraggable(element);
                
                // æ·»åŠ åˆ é™¤åŠŸèƒ½
                element.querySelector('.element-delete').addEventListener('click', function() {
                    element.remove();
                    seaElements = seaElements.filter(el => el !== element);
                });
                
                seaElements.push(element);
            }
            
            function removeAllSeaElements() {
                seaElements.forEach(element => {
                    element.remove();
                });
                seaElements = [];
            }
            
            // é±¼è½®å»“å‚è€ƒåŠŸèƒ½
            fishOutlineSelect.addEventListener('change', function() {
                const outlineType = this.value;
                removeFishOutline();
                
                if (outlineType !== 'none') {
                    drawFishOutline(outlineType);
                    currentOutline = outlineType;
                } else {
                    currentOutline = null;
                }
            });
            
            function drawFishOutline(type) {
                const outline = document.createElement('div');
                outline.className = 'fish-outline';
                
                let size, shape;
                switch(type) {
                    case 'fish1': // å°é±¼
                        size = {width: 80, height: 40};
                        shape = 'ellipse';
                        break;
                    case 'fish2': // é²¨é±¼
                        size = {width: 120, height: 50};
                        shape = 'rectangle';
                        break;
                    case 'fish3': // æ°´æ¯
                        size = {width: 60, height: 80};
                        shape = 'circle';
                        break;
                    case 'fish4': // æµ·é¾Ÿ
                        size = {width: 70, height: 60};
                        shape = 'ellipse';
                        break;
                }
                
                outline.style.width = size.width + 'px';
                outline.style.height = size.height + 'px';
                outline.style.left = (canvas.width / 2 - size.width / 2) + 'px';
                outline.style.top = (canvas.height / 2 - size.height / 2) + 'px';
                
                if (shape === 'ellipse') {
                    outline.style.borderRadius = '50%';
                } else if (shape === 'circle') {
                    outline.style.borderRadius = '50%';
                }
                
                canvas.parentElement.appendChild(outline);
            }
            
            function removeFishOutline() {
                const outline = document.querySelector('.fish-outline');
                if (outline) {
                    outline.remove();
                }
            }
            
            // ä½¿å…ƒç´ å¯æ‹–åŠ¨
            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                element.onmousedown = dragMouseDown;
                
                function dragMouseDown(e) {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }
                
                function elementDrag(e) {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    const newTop = element.offsetTop - pos2;
                    const newLeft = element.offsetLeft - pos1;
                    
                    // ç¡®ä¿å…ƒç´ åœ¨ç”»å¸ƒèŒƒå›´å†…
                    const maxTop = canvas.parentElement.clientHeight - element.offsetHeight;
                    const maxLeft = canvas.parentElement.clientWidth - element.offsetWidth;
                    
                    element.style.top = Math.max(0, Math.min(newTop, maxTop)) + "px";
                    element.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + "px";
                }
                
                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
            
            // ç”»å»ŠåŠŸèƒ½
            galleryTitle.addEventListener('click', function() {
                showGalleryScene();
            });
            
            function showGalleryScene() {
                document.querySelector('.container').style.display = 'none';
                galleryScene.style.display = 'block';
                
                // è®¾ç½®é»˜è®¤èƒŒæ™¯
                currentGalleryBackground = 'spongebob';
                
                // æ¸…ç©ºæµ·æ´‹åœºæ™¯
                oceanScene.innerHTML = '<div class="fish-popup" id="fish-popup"></div>';
                
                // ç»˜åˆ¶ç”»å»ŠèƒŒæ™¯
                drawGalleryBackground();
                
                // æ˜¾ç¤ºç”¨æˆ·æäº¤çš„é±¼
                userFish.forEach((fish, index) => {
                    createSwimmingFish(fish, index);
                });
                
                // æ·»åŠ ç¤ºä¾‹é±¼
                const exampleFish = [
                    {emoji: 'ğŸŸ', name: 'å°ä¸‘é±¼å°¼è«', description: 'æ©™è‰²æ¡çº¹ï¼Œæ´»æ³¼å¥½åŠ¨'},
                    {emoji: 'ğŸ¦ˆ', name: 'å¤§ç™½é²¨', description: 'æµ·æ´‹éœ¸ä¸»ï¼Œå¨é£å‡›å‡›'},
                    {emoji: 'ğŸ¢', name: 'æµ·é¾Ÿæ…¢æ…¢', description: 'é•¿å¯¿æ™ºè€…ï¼Œæ‚ ç„¶è‡ªå¾—'},
                    {emoji: 'ğŸ™', name: 'ç« é±¼åšå£«', description: 'å…«çˆªçµæ´»ï¼Œèªæ˜æœºæ™º'}
                ];
                
                exampleFish.forEach((fish, index) => {
                    createSwimmingFish(fish, userFish.length + index);
                });
            }
            
            function createSwimmingFish(fish, index) {
                const fishElement = document.createElement('div');
                fishElement.className = 'fish-in-ocean';
                fishElement.innerHTML = fish.emoji;
                fishElement.style.left = Math.random() * 80 + '%';
                fishElement.style.top = Math.random() * 70 + 10 + '%';
                fishElement.dataset.fishData = JSON.stringify(fish);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤ºæè¿°
                fishElement.addEventListener('click', function(e) {
                    showFishPopup(fish, e);
                });
                
                oceanScene.appendChild(fishElement);
                
                // æ·»åŠ æ¸¸åŠ¨åŠ¨ç”»
                setTimeout(() => {
                    animateFish(fishElement);
                }, index * 500);
            }
            
            function animateFish(fishElement) {
                const sceneWidth = oceanScene.clientWidth;
                const sceneHeight = oceanScene.clientHeight;
                
                let x = parseFloat(fishElement.style.left) || Math.random() * (sceneWidth - 60);
                let y = parseFloat(fishElement.style.top) || Math.random() * (sceneHeight - 60);
                let vx = (Math.random() - 0.5) * 2;
                let vy = (Math.random() - 0.5) * 1;
                
                function swim() {
                    x += vx;
                    y += vy;
                    
                    // è¾¹ç•Œæ£€æµ‹
                    if (x <= 0 || x >= sceneWidth - 60) {
                        vx = -vx;
                    }
                    if (y <= 10 || y >= sceneHeight - 80) {
                        vy = -vy;
                    }
                    
                    fishElement.style.left = x + 'px';
                    fishElement.style.top = y + 'px';
                    
                    requestAnimationFrame(swim);
                }
                
                swim();
            }
            
            function showFishPopup(fish, event) {
                fishPopup.textContent = fish.description;
                fishPopup.style.display = 'block';
                fishPopup.style.left = (event.pageX - fishPopup.offsetWidth / 2) + 'px';
                fishPopup.style.top = (event.pageY - 40) + 'px';
                
                setTimeout(() => {
                    fishPopup.style.display = 'none';
                }, 3000);
            }
            
            // è¿”å›ç»˜ç”»ç•Œé¢
            backToPaintingBtn.addEventListener('click', function() {
                document.querySelector('.container').style.display = 'flex';
                galleryScene.style.display = 'none';
            });
            
            // ç”»å»ŠèƒŒæ™¯åˆ‡æ¢
            galleryBackgroundTheme.addEventListener('change', function() {
                currentGalleryBackground = this.value;
                drawGalleryBackground();
            });
            
            // æäº¤é±¼åŠŸèƒ½
            submitFishBtn.addEventListener('click', function() {
                fishModal.style.display = 'flex';
            });
            
            cancelSubmitBtn.addEventListener('click', function() {
                fishModal.style.display = 'none';
            });
            
            confirmSubmitBtn.addEventListener('click', function() {
                const fishName = document.getElementById('fish-name').value.trim();
                const fishDescription = document.getElementById('fish-description').value.trim();
                
                if (fishName && fishDescription && fishDescription.length <= 20) {
                    // éšæœºé€‰æ‹©é±¼çš„è¡¨æƒ…ç¬¦å·
                    const fishEmojis = ['ğŸŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ¢', 'ğŸ™', 'ğŸ¦€', 'ğŸ¦', 'ğŸ¦‘', 'ğŸ¬', 'ğŸ‹', 'ğŸ¦'];
                    const randomEmoji = fishEmojis[Math.floor(Math.random() * fishEmojis.length)];
                    
                    const newFish = {
                        emoji: randomEmoji,
                        name: fishName,
                        description: fishDescription
                    };
                    
                    // æ·»åŠ åˆ°ç”¨æˆ·é±¼åˆ—è¡¨
                    userFish.push(newFish);
                    
                    // åˆ›å»ºæ–°çš„é±¼å¡ç‰‡
                    const fishCard = document.createElement('div');
                    fishCard.className = 'fish-card';
                    fishCard.innerHTML = `
                        <div class="fish-preview">${randomEmoji}</div>
                        <div class="fish-name">${fishName}</div>
                        <div class="fish-desc">${fishDescription}</div>
                    `;
                    
                    fishGallery.prepend(fishCard);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    fishModal.style.display = 'none';
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('fish-name').value = '';
                    document.getElementById('fish-description').value = '';
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    alert(`"${fishName}" å·²æˆåŠŸæ·»åŠ åˆ°æµ·æ´‹ç”»å»Šï¼ç‚¹å‡»ç”»å»Šæ ‡é¢˜æŸ¥çœ‹ç”µå­æµ·æ´‹åœºæ™¯ã€‚`);
                } else {
                    alert('è¯·å¡«å†™å®Œæ•´çš„é±¼ç±»ä¿¡æ¯ï¼ï¼ˆæè¿°é™20å­—ï¼‰');
                }
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                if (e.target === fishModal) {
                    fishModal.style.display = 'none';
                }
            });
        }); // DOMContentLoadedç»“æŸ
    </script>
</body>
</html>